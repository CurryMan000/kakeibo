<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
        <style>
/*////////////////////////////////////////////////////////////////////////////
/// スタイル
////////////////////////////////////////////////////////////////////////////*/
            body {
                font-family: Noto Sans JP, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #E4CCCC;
                color: #FBFFFA;
            }
            .content-row {
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                position: relative;
                padding: 20px 0;
            }
            .logo {
                margin-right: 20px;
                margin: 0;
                text-align: center;
                flex-grow: 1;
            }
            .save-btn {
                width: 80px;
                height: 30px;
                font-size: 12px;
                padding: 5px;
                border: none;
                border-radius: 5px;
                background-color: #C39A9C;
                color: #FFFFFF;
                cursor: pointer;
                margin-left: auto;
            }

            .save-btn:hover {
                background-color: #C39A9C;
            }
            form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            input, select, button {
                font-size: 1rem;
                padding: 10px;
                border: 1px solid #E7E7E7;
                border-radius: 5px;
                width: 100%;
                box-sizing: border-box;
            }
            input::placeholder {
                color: #aaa;
            }
            button {
                background-color: #C39A9C;
                color: #FFFFFF;
                border: none;
                cursor: pointer;
            }
            button:hover {
                background-color: #C39A9C;
            }
            button:focus {
                outline: none;
                background-color: #C39A9C;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            table, th, td {
                border: 1px solid #9F9F9F;
            }
            th, td {
                padding: 10px;
                text-align: center;
                background-color: #E7E7E7;
                color:#382831;
            }
            th {
                background-color: #E7E7E7;
                color:#382831;
            }
            .summary {
                margin-top: 20px;
                font-size: 1.2rem;
                text-align: center;
                background-color: white;
                color:#382831;
            }
            @media (max-width: 600px) {
                #calendarContainer table {
                    table-layout: fixed;
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0;
                }

                #calendarContainer th, #calendarContainer td {
                    width: 14.28%;
                    word-wrap: break-word;
                    border: none;
                }
                
                #calendarContainer th {
                    font-size: 0.5rem;
                    background-color: #C39A9C;
                    color: #382831;
                }

                #calendarContainer {
                    overflow-x: auto;
                }
                #calendar td {
                    border-bottom: 1px solid #9F9F9F;
                    background-color: whitesmoke;
                    color: #382831;
                }

                #calendar td span {
                    font-size: 0.5rem;
                    display: block;
                    text-align: center;
                }

                #calendar td .expense {
                    font-size: 0.5rem;
                    display: block;
                    text-align: center;
                    margin-top: 3px;
                }

                #calendar td .expense.food {
                    color: #aa1a00;
                }

                #calendar td .expense.household {
                    color: #009400;
                }

                #calendar td .expense.dining {
                    color: #947e02;
                }

                #calendar td .expense.special {
                    color: #50009b;
                }
            }
            footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                background-color: #382831;
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                color: #F0E2E2;
            }
            footer button {
                background: none;
                border: none;
                color: #F0E2E2;
                font-size: 1rem;
                cursor: pointer;
            }
            footer button.active {
                font-weight: bold;
                text-decoration: underline;
                background-color: #382831;
                color: #ED8620;
            }
            footer button:hover {
                opacity: 0.8;
            }
            #graphContainer {
                text-align: center;
                padding: 50px;
            }
            .button-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            .button-group button {
                padding: 10px 20px;
                font-size: 1rem;
                flex: 0 0 30%;
                max-width: 120px;
                background-color: #ADE0EE;
                color: white;
                border: none;
                border-radius: 5px;
            }
        </style>
    </head>

    <body>
        <div id="content">
<!--/////////////////////////////////////////////////////////////////////////
/// 入力タブ
//////////////////////////////////////////////////////////////////////////-->
            <div id="entryFormSection">
                <div id="loading-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="loading-message" style="color: black;">読み込み中...</p>
                        <button id="close-button" onclick="closeLoadingModal()" style="display: none; margin-top: 10px;">閉じる</button>
                    </div>
                </div>

                <div id="saving-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="saving-message" style="color: black;">保存中...</p>
                        <button id="close-savebutton" onclick="closeSavingModal()" style="display: none; margin-top: 10px;">閉じる</button>
                    </div>
                </div>

                <div class="content-row">
                    <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="100%" height="70">
                        <text x="50%" y="50%" font-family="-apple-syste, Comic Sans MS, sans-serif" font-size="30" font-weight="bold" fill="#382831"text-anchor="middle" alignment-baseline="middle">
                            　　２０２５
                        </text>
                    </svg>
                    <button id="saveButton" class="save-btn" onclick="saveEntry()">
                        保存
                    </button>
                </div>
                <form id="entryForm">
                    <select id="month" onchange="onchangeEntryMonth()">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>

                    <input type="number" id="date" placeholder="日付">

                    <select id="category">
                        <option value="お肉">お肉</option>
                        <option value="飲料">飲料</option>
                        <option value="野菜">野菜</option>
                        <option value="お菓子">お菓子</option>
                        <option value="生活用品">生活用品</option>
                        <option value="外食">外食</option>
                        <option value="特別">特別</option>
                        <option value="水道">水道</option>
                        <option value="ガス">ガス</option>
                        <option value="電気">電気</option>
                        <option value="その他">その他</option>
                    </select>
                    
                    <input type="number" id="amount" placeholder="金額を入力">

                    <button type="button" onclick="addEntry()">追加</button>
                </form>

                <div class="summary">
                    <p>総支出: <span id="totalExpense">0</span> 円</p>
                </div>

                <table id="entriesTable">
                    <thead>
                        <tr>
                            <th>月</th>
                            <th>日付</th>
                            <th>分類</th>
                            <th>金額</th>
                            <th>削除</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 記録がここに追加される -->
                    </tbody>
                </table>

            </div>
<!--/////////////////////////////////////////////////////////////////////////
/// 月グラフタブ
//////////////////////////////////////////////////////////////////////////-->
            <div id="monthlyGraphSection" style="display: none;">
                <select id="monthgraph_month" onchange="onchangeSelectMonth()">
                    <option value="1">1月</option>
                    <option value="2">2月</option>
                    <option value="3">3月</option>
                    <option value="4">4月</option>
                    <option value="5">5月</option>
                    <option value="6">6月</option>
                    <option value="7">7月</option>
                    <option value="8">8月</option>
                    <option value="9">9月</option>
                    <option value="10">10月</option>
                    <option value="11">11月</option>
                    <option value="12">12月</option>
                </select>

                <div id="graphContainer">
                    <canvas id="monthlyGraph" width="800" height="800"></canvas>
                </div>
            </div>
<!--/////////////////////////////////////////////////////////////////////////
/// 年グラフタブ
//////////////////////////////////////////////////////////////////////////-->
            <div id="yearlyGraphSection" style="display: none;">
                <select id="yeargraph_category" onchange="onchangeSelectYear()">
                    <option value="total">総支出</option>
                    <option value="お肉">お肉</option>
                    <option value="飲料">飲料</option>
                    <option value="野菜">野菜</option>
                    <option value="お菓子">お菓子</option>
                    <option value="生活用品">生活用品</option>
                    <option value="外食">外食</option>
                    <option value="特別">特別</option>
                    <option value="水道">水道</option>
                    <option value="ガス">ガス</option>
                    <option value="電気">電気</option>
                    <option value="その他">その他</option>
                </select>

                <div id="graphContainer">
                    <canvas id="yearlyGraph" width="500" height="500"></canvas>
                </div>
            </div>
 <!--/////////////////////////////////////////////////////////////////////////
/// カレンダータブ
//////////////////////////////////////////////////////////////////////////-->
            <div id="calendarSection" style="display: none;">
                <select id="calendarMonth" onchange="updateCalendar()">
                    <option value="1">1月</option>
                    <option value="2">2月</option>
                    <option value="3">3月</option>
                    <option value="4">4月</option>
                    <option value="5">5月</option>
                    <option value="6">6月</option>
                    <option value="7">7月</option>
                    <option value="8">8月</option>
                    <option value="9">9月</option>
                    <option value="10">10月</option>
                    <option value="11">11月</option>
                    <option value="12">12月</option>
                </select>
                
                <div id="calendarContainer">
                    <table id="calendar">
                        <thead>
                            <tr>
                                <th>月</th>
                                <th>火</th>
                                <th>水</th>
                                <th>木</th>
                                <th>金</th>
                                <th>土</th>
                                <th>日</th>
                                <th>合計</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- カレンダーがここに生成される -->
                        </tbody>
                    </table>
                </div>
            </div>       
<!--/////////////////////////////////////////////////////////////////////////
/// ウォレットタブ
//////////////////////////////////////////////////////////////////////////-->
            <div id="walletSection" style="display: none;">
                <div id="savingwallet-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="savingwallet-message" style="color: black;">保存中...</p>
                        <button id="close-savewalletbutton" onclick="closeSavingWalletModal()" style="display: none; margin-top: 10px;">閉じる</button>
                    </div>
                </div>
                <div class="content-row">
                    <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="100%" height="70">
                        <text x="50%" y="50%" font-family="-apple-syste, Comic Sans MS, sans-serif" font-size="30" font-weight="bold" fill="#382831"text-anchor="middle" alignment-baseline="middle">
                            共有口座
                        </text>
                    </svg>
                </div>

                <form id="WalletForm">
                    <select id="walletMonth" onchange="onchangeWallentMonth()">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>

                    <input type="number" id="walletDate" placeholder="日付">

                    <select id="walletCategory">
                        <option value="振込">振込</option>
                        <option value="払出">払出</option>
                    </select>
                    <input type="number" id="walletAmount" placeholder="金額">
                    <button type="button" onclick="saveWallet()">保存</button>
                </form>

                <div class="summary">
                    <p>残高: <span id="walletCurrent">0</span> 円</p>
                </div>

                <table id="walletTable">
                    <thead>
                        <tr>
                            <th>月</th>
                            <th>日</th>
                            <th>分類</th>
                            <th>金額</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 記録がここに追加される -->
                    </tbody>
                </table>
            </div>
        </div>
<!--/////////////////////////////////////////////////////////////////////////
/// フッタースタイル
//////////////////////////////////////////////////////////////////////////-->
        <footer>
            <button onclick="showSection('entryFormSection', this)" class="active">
                <span class="material-symbols-outlined">
                    library_books
                </span>
            </button>
            <button onclick="showSection('monthlyGraphSection', this)">
                <span class="material-symbols-outlined">
                    pie_chart
                </span>
            </button>
            <button onclick="showSection('yearlyGraphSection', this)">
                <span class="material-symbols-outlined">
                    bar_chart_4_bars
                </span>
            </button>
            <button onclick="showSection('calendarSection', this)">
                <span class="material-symbols-outlined">
                    calendar_month
                </span>
            </button>
            <button onclick="showSection('walletSection', this)">
                <span class="material-symbols-outlined">
                    wallet
                </span>
            </button>
        </footer>

<!--//////////////////////////////////////////////////////////////////////////
/// 起動時処理
///////////////////////////////////////////////////////////////////////////-->       
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let entries = [];       //入力データリスト
            let wallets = [];       //口座金額リスト
            let saveEntries = [];   //保存入力データリスト
            let selectedMonth = 1;  //入力タブで選択されている月
            let walletCurrent = 0;  //現在残高
            let walletBalance = 0;  //見込残高
            let monthlyChart = null;
            let yearlyChart = null;
            
            window.onload = function() {
                fetch("https://script.google.com/macros/s/AKfycbyBGopO2qSAGtUVQtSUc6Wc-Ok-7PjmBUvuGhDLIyeumddTxPMTWs7S2FsUaXhRZmOdBw/exec")
                // ウォレットテーブルにデータを追加
                .then(response => response.json())
                    .then(data => {
                        data.forEach(row => {
                            const month = row[0];
                            const date = row[1];
                            const category = row[2];
                            const amount = row[3];
                            const wallet = { month, date, category, amount };
                            wallets.unshift(wallet);
                        });
                        wallets.forEach(wallet=>{
                            if (wallet.category==='振込') {
                                walletCurrent += wallet.amount;
                            }
                            else if (wallet.category==='払出') {
                                walletCurrent -= wallet.amount;
                            }
                        });
                        //ウォレットテーブルの更新
                        updateWalletDisplay();
                    }
                );
                document.getElementById("loading-modal").style.display = "flex";
                fetch("https://script.google.com/macros/s/AKfycbz_Vi5dDG8ejJyAiPIc3RHuwOi-xZtEXNe3st-soEPFw9YX5WCE9gNcBSsWRbyKBMNqbw/exec")
                    .then(response => response.json())
                    .then(data => {
                        //最終月を設定
                        if (data.length > 0) {
                            selectedMonth = data[data.length - 1][0];
                            document.getElementById('month').value = selectedMonth;
                        }

                        // 入力テーブルにデータを追加
                        data.forEach(row => {
                            const month = row[0];
                            const date = row[1];
                            const category = row[3];
                            const amount = row[2];
                            const entry = { date, category, amount, month, isNew:false };
                            entries.unshift(entry);
                        });
                        //入力テーブルの更新
                        updateEntriesTable();
                        //メッセージ表示
                        document.getElementById("loading-message").textContent = "読み込みました🎵";
                        document.getElementById("close-button").style.display = "block";
                    })
                    .catch(error => {
                        document.getElementById("loading-message").textContent = "読み込みに失敗しました";
                        document.getElementById("close-button").style.display = "block";
                    }
                );
            };
            // モーダルを閉じる
            function closeLoadingModal() {
                document.getElementById("loading-modal").style.display = "none";
            }
            
//////////////////////////////////////////////////////////////////////////////
/// 入力画面処理
//////////////////////////////////////////////////////////////////////////////

            // 入力データソート
            document.addEventListener("DOMContentLoaded", function () {
                const table = document.getElementById("entriesTable");
                const headers = table.querySelectorAll("thead th");
                let sortOrder = {}; // 各列のソート順を記録

                headers.forEach((header, columnIndex) => {
                    if (columnIndex === 4) return; // 削除ボタン列はソートしない

                    sortOrder[columnIndex] = 1; // 初期は昇順

                    header.addEventListener("click", function () {
                        const tbody = table.querySelector("tbody");
                        const rows = Array.from(tbody.querySelectorAll("tr"));

                        // ソート処理
                        rows.sort((rowA, rowB) => {
                            const cellA = rowA.children[columnIndex].textContent.trim();
                            const cellB = rowB.children[columnIndex].textContent.trim();

                            // 数値かどうか判定
                            const isNumber = !isNaN(cellA) && !isNaN(cellB);

                            if (isNumber) {
                                return (parseFloat(cellA) - parseFloat(cellB)) * sortOrder[columnIndex];
                            } else {
                                return cellA.localeCompare(cellB, "ja") * sortOrder[columnIndex];
                            }
                        });

                        // ソート順を反転
                        sortOrder[columnIndex] *= -1;

                        // ソートした行をテーブルに再追加
                        tbody.innerHTML = "";
                        rows.forEach(row => tbody.appendChild(row));
                    });
                });
            });

            // 保存ボタンが押された時
            function saveEntry(){
                document.getElementById("saving-modal").style.display = "flex";
                event.preventDefault(); // デフォルトのフォーム送信動作を防ぐ

                if (saveEntries.length === 0) {
                    document.getElementById("saving-message").textContent = "保存するデータがありません";
                    document.getElementById("close-savebutton").style.display = "block";
                    return;
                }

                // saveEntriesを送信可能な形式に変換
                const formData = new URLSearchParams();
                saveEntries.forEach((entry, index) => {
                    Object.keys(entry).forEach(key => {
                        formData.append(`${index}[${key}]`, entry[key]);
                    });
                });

                // Google Apps Scriptにデータを送信
                fetch("https://script.google.com/macros/s/AKfycbz_Vi5dDG8ejJyAiPIc3RHuwOi-xZtEXNe3st-soEPFw9YX5WCE9gNcBSsWRbyKBMNqbw/exec", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById("saving-message").textContent = "保存しました🎵";
                        document.getElementById("close-savebutton").style.display = "block";

                        entries.forEach(entry => {
                            if (saveEntries.includes(entry)) {
                                entry.isNew = false;
                            }
                        });
                        saveEntries = []; // 保存済みのエントリをクリア
                        updateEntriesTable();
                    } else {
                        document.getElementById("saving-message").textContent = "保存に失敗しました。";
                        document.getElementById("close-savebutton").style.display = "block";
                    }
                })
                .catch(error => {
                    console.error("保存中にエラーが発生しました:", error);
                    document.getElementById("saving-message").textContent = "保存に失敗しました。";
                    document.getElementById("close-savebutton").style.display = "block";
                });
            }
            // モーダルを閉じる
            function closeSavingModal() {
                document.getElementById("saving-modal").style.display = "none";
            }

            // 追加ボタンが押されたとき
            function addEntry() {
                const date = document.getElementById('date').value;
                const category = document.getElementById('category').value;
                const amount = parseInt(document.getElementById('amount').value);
                const month = parseInt(document.getElementById('month').value);

                if (isNaN(amount) || !date) {
                    alert('金額と日付を入力してください。');
                    return;
                }

                const entry = { date, category, amount, month, isNew:true };
                entries.unshift(entry);
                saveEntries.unshift(entry);

                document.getElementById('amount').value=null;

                updateEntriesTable();
            }

            // エントリテーブルの更新
            function updateEntriesTable() {
                const tbody = document.getElementById('entriesTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                let totalExpense = 0;

                entries.filter(entry => entry.month === selectedMonth).forEach(entry => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = entry.month;
                        row.insertCell(1).textContent = entry.date;
                        row.insertCell(2).textContent = entry.category;
                        row.insertCell(3).textContent = entry.amount;

                        // 削除ボタンが押されたとき
                        const deleteCell = row.insertCell(4);
                        if(entry.isNew){
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = '削除';
                        deleteButton.onclick = () => {
                            entries = entries.filter(e => e !== entry);
                            saveEntries = saveEntries.filter(e => e !== entry);
                            updateEntriesTable();
                        };
                        deleteCell.appendChild(deleteButton);
                    }

                    totalExpense += entry.amount;
                });

                // 総支出の表示
                document.getElementById('totalExpense').textContent = totalExpense;
            }
            //入力タブの月ドロップダウンが変更されたとき
            function onchangeEntryMonth(){
                selectedMonth = parseInt(document.getElementById('month').value);
                updateEntriesTable();
            }

//////////////////////////////////////////////////////////////////////////////
/// 月グラフ処理
//////////////////////////////////////////////////////////////////////////////

            // 月タブのドロップダウンが変更されたとき
            function onchangeSelectMonth(){
                const month = parseInt(document.getElementById('monthgraph_month').value);
                updateMonthlyGraph(month);
            }
            //月グラフの更新
            function updateMonthlyGraph(month) {
                if (monthlyChart) {
                    monthlyChart.destroy();
                }

                const categoryAmounts = {
                    'お肉': 0, '飲料': 0, '野菜': 0, 'お菓子': 0, '生活用品': 0, '外食': 0,
                    '特別': 0, '水道': 0, 'ガス': 0, '電気': 0, 'その他': 0
                };

                let hasData = false;

                // その月のデータを集計
                entries.forEach(entry => {
                    if (entry.month === month) {
                        categoryAmounts[entry.category] += entry.amount;
                        hasData = true;
                    }
                });

                if (!hasData) {
                    alert(`${month}月のデータがありません。`);
                    return;
                }

                
                // 金額が0でない分類をフィルタリング
                const filteredCategoryAmounts = Object.fromEntries(
                    Object.entries(categoryAmounts).filter(([category, amount]) => amount > 0)
                );

                if (Object.keys(filteredCategoryAmounts).length === 0) {
                    alert(`${month}月に金額が0の分類はありません。`);
                    return;
                }

                // ラベルを「分類：金額」の形式に変換
                const labels = Object.keys(filteredCategoryAmounts).map(
                    category => `${category}：${filteredCategoryAmounts[category]}円`
                );

                const ctx = document.getElementById('monthlyGraph').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${month}月の支出`,
                            data: Object.values(filteredCategoryAmounts),
                            backgroundColor: ['#FFB7C5', '#AEC6CF', '#77DD77', '#FDFD96', '#CBAACB', '#FFB347', '#FBEEC1', '#FF9AA2', '#E6E6FA', '#B2F2E9', '#D3D3D3'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false,
                                position: 'top',
                                labels: {
                                    boxWidth: 20,
                                    padding: 10
                                }
                            },
                            tooltip: {
                                enabled: false // ツールチップを無効にする
                            }
                        }
                    },
                    plugins: [{
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                if (!meta.hidden) {
                                    meta.data.forEach((element, index) => {
                                        const label = `${chart.data.labels[index]}`; // "分類：金額"の形式
                                        const position = element.tooltipPosition();

                                        // グラフの中心位置を取得
                                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;

                                        // セクションの中心からのオフセット距離を計算
                                        const deltaX = position.x - centerX;
                                        const deltaY = position.y - centerY;

                                        // 位置調整
                                        const offsetX = centerX + deltaX * 1.5;
                                        const offsetY = centerY + deltaY * 1.5;

                                        ctx.fillStyle = '#382831'; // テキストの色

                                        // テキストを描画
                                        ctx.font = 'bold 12px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';

                                        ctx.fillText(label, offsetX, offsetY);
                                    });
                                }
                            });
                        }
                    }]
                });
            }

//////////////////////////////////////////////////////////////////////////////
/// 年グラフ処理
//////////////////////////////////////////////////////////////////////////////

            // 年グラフのドロップダウンが更新されたとき
            function onchangeSelectYear(){
                const selectedCategory = document.getElementById('yeargraph_category').value;
                if (selectedCategory === 'total') {
                    updateYearlyGraph();
                } else {
                    updateCategoryYearlyGraph(selectedCategory);
                }
            }

            // 総支出グラフ
            function updateYearlyGraph() {
                if (yearlyChart) {
                    yearlyChart.destroy();
                }
                // 各月の総支出を計算
                const monthlyTotals = Array(12).fill(0);
                entries.forEach(entry => {
                    monthlyTotals[entry.month - 1] += entry.amount;
                });

                const ctx = document.getElementById('yearlyGraph').getContext('2d');
                yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: '総支出',
                            data: monthlyTotals,
                            backgroundColor: '#382831',
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }


            // カテゴリーグラフ
            function updateCategoryYearlyGraph(category) {
                if (yearlyChart) {
                    yearlyChart.destroy();
                }

                const categoryColors = {
                    'お肉': '#FFB7C5',
                    '飲料': '#AEC6CF',
                    '野菜': '#77DD77',
                    'お菓子': '#FDFD96',
                    '生活用品': '#CBAACB',
                    '外食': '#FFB347',
                    '特別': '#FBEEC1',
                    '水道': '#FF9AA2',
                    'ガス': '#E6E6FA',
                    '電気': '#B2F2E9',
                    'その他': '#D3D3D3'
                };

                const monthlyTotals = Array(12).fill(0);

                entries.forEach(entry => {
                    if (entry.category === category) {
                        monthlyTotals[entry.month - 1] += entry.amount;
                    }
                });

                const colors = monthlyTotals.map(() => categoryColors[category] || '#382831');

                const ctx = document.getElementById('yearlyGraph').getContext('2d');
                yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: `${category}の月別支出`,
                            data: monthlyTotals,
                            backgroundColor: colors,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
//////////////////////////////////////////////////////////////////////////////
/// カレンダー処理
//////////////////////////////////////////////////////////////////////////////
            function updateCalendar() {
                const selectedMonth = document.getElementById("calendarMonth").value;
                generateCalendar(selectedMonth);
            }

            function generateCalendar(month) {
                const tbody = document.querySelector("#calendar tbody");
                tbody.innerHTML = "";

                const firstDay = new Date(2025, month - 1, 1).getDay();
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                const daysInMonth = new Date(2025, month, 0).getDate();

                let row = document.createElement("tr");
                let weeklyTotals = {
                    食費: 0,
                    生活用品: 0,
                    外食費: 0,
                    特別費: 0
                };

                // 月の初めの空白のセルを追加
                for (let i = 0; i < adjustedFirstDay; i++) {
                    row.appendChild(document.createElement("td"));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    let cell = document.createElement("td");

                    // 日付を表示
                    let dateSpan = document.createElement("span");
                    dateSpan.textContent = day;
                    cell.appendChild(dateSpan);

                    // 各費用の表示（0円でも表示）
                    let expenses = [
                        { category: "食費", class: "food" },
                        { category: "生活用品", class: "household" },
                        { category: "外食費", class: "dining" },
                        { category: "特別費", class: "special" }
                    ];

                    expenses.forEach(expense => {
                        let expenseSpan = document.createElement("span");
                        expenseSpan.classList.add("expense", expense.class);
                        let amount = calculateExpense(day, expense.category, month); // 月と日付に基づく金額を計算
                        expenseSpan.textContent = `${amount}円`; // カテゴリ名は表示せず、金額のみ
                        cell.appendChild(expenseSpan);

                        // 週ごとの合計を計算
                        weeklyTotals[expense.category] += amount;
                    });

                    row.appendChild(cell);

                    // 日曜日（7日目）または月末の時に週合計を表示
                    if ((day + adjustedFirstDay) % 7 === 0 || day === daysInMonth) {
                        // 週合計列を追加
                        let summaryCell = document.createElement("td");

                        // 食費
                        let foodSpan = document.createElement("span");
                        foodSpan.classList.add("weekly-total", "food");
                        foodSpan.textContent = `${weeklyTotals.食費}円`;
                        summaryCell.appendChild(foodSpan);

                        // 生活用品
                        let householdSpan = document.createElement("span");
                        householdSpan.classList.add("weekly-total", "household");
                        householdSpan.textContent = `${weeklyTotals.生活用品}円`;
                        summaryCell.appendChild(householdSpan);

                        // 外食費
                        let diningSpan = document.createElement("span");
                        diningSpan.classList.add("weekly-total", "dining");
                        diningSpan.textContent = `${weeklyTotals.外食費}円`;
                        summaryCell.appendChild(diningSpan);

                        // 特別費
                        let specialSpan = document.createElement("span");
                        specialSpan.classList.add("weekly-total", "special");
                        specialSpan.textContent = `${weeklyTotals.特別費}円`;
                        summaryCell.appendChild(specialSpan);

                        row.appendChild(summaryCell);
                        tbody.appendChild(row);
                        row = document.createElement("tr");

                        // 週合計をリセット
                        weeklyTotals = {
                            食費: 0,
                            生活用品: 0,
                            外食費: 0,
                            特別費: 0
                        };
                    }
                }
            }

            // 計算した費用を取得する関数
            function calculateExpense(day, category, month) {
                let total = 0;
                entries.forEach(entry => {
                    if (entry.month == month && entry.date == day) {
                        if (category === "食費" && ["お肉", "野菜", "飲料", "お菓子", "その他"].includes(entry.category)) {
                            total += entry.amount;
                        } else if (category === "生活用品" && entry.category === "生活用品") {
                            total += entry.amount;
                        } else if (category === "外食費" && entry.category === "外食") {
                            total += entry.amount;
                        } else if (category === "特別費" && entry.category === "特別") {
                            total += entry.amount;
                        }
                    }
                });
                return total === 0 ? "0" : total; // 0円も表示する
            }



//////////////////////////////////////////////////////////////////////////////
/// ウォレット処理
//////////////////////////////////////////////////////////////////////////////
            // ウォレット保存処理
            function saveWallet(){
                event.preventDefault(); // デフォルトのフォーム送信動作を防ぐ
                const month = parseInt(document.getElementById("walletMonth").value);
                const date = document.getElementById("walletDate").value;
                const category = document.getElementById("walletCategory").value;
                const amount = parseInt(document.getElementById("walletAmount").value);
                if (category==='振込') {
                    walletCurrent += amount;
                }
                else if (category==='払出') {
                    walletCurrent -= amount;
                }
                else{
                    alert("金額を入力してや♪");
                }
                document.getElementById("walletDate").value = "";
                document.getElementById("walletAmount").value = "";

                const wallet={ month, date, category, amount };
                wallets.unshift(wallet);
                if (wallet.length === 0) {
                    alert("保存するデータがありません。");
                    return;
                }

                // savewalletを送信可能な形式に変換
                const formData = new URLSearchParams();
                Object.keys(wallet).forEach(key => {
                    formData.append(`0[${key}]`, wallet[key]);
                });
                document.getElementById("savingwallet-modal").style.display = "flex";

                // Google Apps Scriptにデータを送信
                fetch("https://script.google.com/macros/s/AKfycbyBGopO2qSAGtUVQtSUc6Wc-Ok-7PjmBUvuGhDLIyeumddTxPMTWs7S2FsUaXhRZmOdBw/exec", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById("savingwallet-message").textContent = "保存しました♪";
                        document.getElementById("close-savewalletbutton").style.display = "block";
                        updateWalletDisplay()
                    } else {
                        document.getElementById("savingwallet-message").textContent = "保存に失敗しました。";
                        document.getElementById("close-savewalletbutton").style.display = "block";
                    }
                })
                .catch(error => {
                    document.getElementById("savingwallet-message").textContent = "保存に失敗しました。";
                    document.getElementById("close-savewalletbutton").style.display = "block";
                });
            }

            // モーダルを閉じる
            function closeSavingWalletModal() {
                document.getElementById("savingwallet-modal").style.display = "none";
            }

            // ウォレット表示の更新
            function updateWalletDisplay() {
                const tbody = document.getElementById('walletTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                wallets.forEach(wallet => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = wallet.month;
                        row.insertCell(1).textContent = wallet.date;
                        row.insertCell(2).textContent = wallet.category;
                        row.insertCell(3).textContent = wallet.amount;
            });
                document.getElementById("walletCurrent").textContent = walletCurrent;
                document.getElementById("walletBalance").textContent = walletBalance;
            }

//////////////////////////////////////////////////////////////////////////////
/// タブ切り替え処理
//////////////////////////////////////////////////////////////////////////////
            function showSection(sectionId, button) {
                const sections = ['entryFormSection', 'monthlyGraphSection', 'yearlyGraphSection','calendarSection','walletSection'];
                sections.forEach(id => {
                    const section = document.getElementById(id);
                    section.style.display = (id === sectionId) ? 'block' : 'none';
                });

                const buttons = document.querySelectorAll('footer button');
                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // 各タブが押されたときの処理
                if (sectionId === 'monthlyGraphSection') {
                    const correntmonth = document.getElementById('month').value
                    document.getElementById('monthgraph_month').value = correntmonth;
                    updateMonthlyGraph(parseInt(correntmonth, 10));
                } else if (sectionId === 'yearlyGraphSection') {
                    document.getElementById('yeargraph_category').value = 'total';
                    updateYearlyGraph();
                } else if (sectionId === 'calendarSection') {
                    updateCalendar();
                } else if (sectionId === 'walletSection') {
                    updateWalletDisplay();
                }
            }
        </script>
    </body>
</html>
