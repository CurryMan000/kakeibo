<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
        <style>
/*////////////////////////////////////////////////////////////////////////////
/// ã‚¹ã‚¿ã‚¤ãƒ«
////////////////////////////////////////////////////////////////////////////*/
            body {
                font-family: Noto Sans JP, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #E4CCCC;
                color: #FBFFFA;
            }
            .content-row {
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                position: relative;
                padding: 20px 0;
            }
            .logo {
                margin-right: 20px;
                margin: 0;
                text-align: center;
                flex-grow: 1;
            }
            .save-btn {
                width: 80px;
                height: 30px;
                font-size: 12px;
                padding: 5px;
                border: none;
                border-radius: 5px;
                background-color: #C39A9C;
                color: #FFFFFF;
                cursor: pointer;
                margin-left: auto;
            }

            .save-btn:hover {
                background-color: #C39A9C;
            }
            form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            input, select, button {
                font-size: 1rem;
                padding: 10px;
                border: 1px solid #E7E7E7;
                border-radius: 5px;
                width: 100%;
                box-sizing: border-box;
            }
            input::placeholder {
                color: #aaa;
            }
            button {
                background-color: #C39A9C;
                color: #FFFFFF;
                border: none;
                cursor: pointer;
            }
            button:hover {
                background-color: #C39A9C;
            }
            button:focus {
                outline: none;
                background-color: #C39A9C;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            table, th, td {
                border: 1px solid #9F9F9F;
            }
            th, td {
                padding: 10px;
                text-align: center;
                background-color: #E7E7E7;
                color:#382831;
            }
            th {
                background-color: #E7E7E7;
                color:#382831;
            }
            .summary {
                margin-top: 20px;
                font-size: 1.2rem;
                text-align: center;
                background-color: white;
                color:#382831;
            }
            @media (max-width: 600px) {
                #calendarContainer table {
                    table-layout: fixed;
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0;
                }

                #calendarContainer th, #calendarContainer td {
                    width: 14.28%;
                    word-wrap: break-word;
                    border: none;
                }
                
                #calendarContainer th {
                    font-size: 0.5rem;
                    background-color: #C39A9C;
                    color: #382831;
                }

                #calendarContainer {
                    overflow-x: auto;
                }
                #calendar td {
                    border-bottom: 1px solid #9F9F9F;
                    background-color: whitesmoke;
                    color: #382831;
                }

                #calendar td span {
                    font-size: 0.5rem;
                    display: block;
                    text-align: center;
                }

                #calendar td .expense {
                    font-size: 0.5rem;
                    display: block;
                    text-align: center;
                    margin-top: 3px;
                }

                #calendar td .expense.food {
                    color: #aa1a00;
                }

                #calendar td .expense.household {
                    color: #009400;
                }

                #calendar td .expense.dining {
                    color: #947e02;
                }

                #calendar td .expense.special {
                    color: #50009b;
                }
            }
            footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                background-color: #382831;
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                color: #F0E2E2;
            }
            footer button {
                background: none;
                border: none;
                color: #F0E2E2;
                font-size: 1rem;
                cursor: pointer;
            }
            footer button.active {
                font-weight: bold;
                text-decoration: underline;
                background-color: #382831;
                color: #ED8620;
            }
            footer button:hover {
                opacity: 0.8;
            }
            #graphContainer {
                text-align: center;
                padding: 50px;
            }
            .button-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            .button-group button {
                padding: 10px 20px;
                font-size: 1rem;
                flex: 0 0 30%;
                max-width: 120px;
                background-color: #ADE0EE;
                color: white;
                border: none;
                border-radius: 5px;
            }
        </style>
    </head>

    <body>
        <div id="content">
<!--/////////////////////////////////////////////////////////////////////////
/// å…¥åŠ›ã‚¿ãƒ–
//////////////////////////////////////////////////////////////////////////-->
            <div id="entryFormSection">
                <div id="loading-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="loading-message" style="color: black;">èª­ã¿è¾¼ã¿ä¸­...</p>
                        <button id="close-button" onclick="closeLoadingModal()" style="display: none; margin-top: 10px;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>

                <div id="saving-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="saving-message" style="color: black;">ä¿å­˜ä¸­...</p>
                        <button id="close-savebutton" onclick="closeSavingModal()" style="display: none; margin-top: 10px;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>

                <div class="content-row">
                    <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="100%" height="70">
                        <text x="50%" y="50%" font-family="-apple-syste, Comic Sans MS, sans-serif" font-size="30" font-weight="bold" fill="#382831"text-anchor="middle" alignment-baseline="middle">
                            ã€€ã€€ï¼’ï¼ï¼’ï¼•
                        </text>
                    </svg>
                    <button id="saveButton" class="save-btn" onclick="saveEntry()">
                        ä¿å­˜
                    </button>
                </div>
                <form id="entryForm">
                    <select id="month" onchange="onchangeEntryMonth()">
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>

                    <input type="number" id="date" placeholder="æ—¥ä»˜">

                    <select id="category">
                        <option value="ãŠè‚‰">ãŠè‚‰</option>
                        <option value="é£²æ–™">é£²æ–™</option>
                        <option value="é‡èœ">é‡èœ</option>
                        <option value="ãŠè“å­">ãŠè“å­</option>
                        <option value="ç”Ÿæ´»ç”¨å“">ç”Ÿæ´»ç”¨å“</option>
                        <option value="å¤–é£Ÿ">å¤–é£Ÿ</option>
                        <option value="ç‰¹åˆ¥">ç‰¹åˆ¥</option>
                        <option value="æ°´é“">æ°´é“</option>
                        <option value="ã‚¬ã‚¹">ã‚¬ã‚¹</option>
                        <option value="é›»æ°—">é›»æ°—</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    
                    <input type="number" id="amount" placeholder="é‡‘é¡ã‚’å…¥åŠ›">

                    <button type="button" onclick="addEntry()">è¿½åŠ </button>
                </form>

                <div class="summary">
                    <p>ç·æ”¯å‡º: <span id="totalExpense">0</span> å††</p>
                </div>

                <table id="entriesTable">
                    <thead>
                        <tr>
                            <th>æœˆ</th>
                            <th>æ—¥ä»˜</th>
                            <th>åˆ†é¡</th>
                            <th>é‡‘é¡</th>
                            <th>å‰Šé™¤</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¨˜éŒ²ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </tbody>
                </table>

            </div>
<!--/////////////////////////////////////////////////////////////////////////
/// æœˆã‚°ãƒ©ãƒ•ã‚¿ãƒ–
//////////////////////////////////////////////////////////////////////////-->
            <div id="monthlyGraphSection" style="display: none;">
                <select id="monthgraph_month" onchange="onchangeSelectMonth()">
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>

                <div id="graphContainer">
                    <canvas id="monthlyGraph" width="800" height="800"></canvas>
                </div>
            </div>
<!--/////////////////////////////////////////////////////////////////////////
/// å¹´ã‚°ãƒ©ãƒ•ã‚¿ãƒ–
//////////////////////////////////////////////////////////////////////////-->
            <div id="yearlyGraphSection" style="display: none;">
                <select id="yeargraph_category" onchange="onchangeSelectYear()">
                    <option value="total">ç·æ”¯å‡º</option>
                    <option value="ãŠè‚‰">ãŠè‚‰</option>
                    <option value="é£²æ–™">é£²æ–™</option>
                    <option value="é‡èœ">é‡èœ</option>
                    <option value="ãŠè“å­">ãŠè“å­</option>
                    <option value="ç”Ÿæ´»ç”¨å“">ç”Ÿæ´»ç”¨å“</option>
                    <option value="å¤–é£Ÿ">å¤–é£Ÿ</option>
                    <option value="ç‰¹åˆ¥">ç‰¹åˆ¥</option>
                    <option value="æ°´é“">æ°´é“</option>
                    <option value="ã‚¬ã‚¹">ã‚¬ã‚¹</option>
                    <option value="é›»æ°—">é›»æ°—</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>

                <div id="graphContainer">
                    <canvas id="yearlyGraph" width="500" height="500"></canvas>
                </div>
            </div>
 <!--/////////////////////////////////////////////////////////////////////////
/// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–
//////////////////////////////////////////////////////////////////////////-->
            <div id="calendarSection" style="display: none;">
                <select id="calendarMonth" onchange="updateCalendar()">
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
                
                <div id="calendarContainer">
                    <table id="calendar">
                        <thead>
                            <tr>
                                <th>æœˆ</th>
                                <th>ç«</th>
                                <th>æ°´</th>
                                <th>æœ¨</th>
                                <th>é‡‘</th>
                                <th>åœŸ</th>
                                <th>æ—¥</th>
                                <th>åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>       
<!--/////////////////////////////////////////////////////////////////////////
/// ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¿ãƒ–
//////////////////////////////////////////////////////////////////////////-->
            <div id="walletSection" style="display: none;">
                <div id="savingwallet-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 10px; text-align: center; min-width: 250px;">
                        <p id="savingwallet-message" style="color: black;">ä¿å­˜ä¸­...</p>
                        <button id="close-savewalletbutton" onclick="closeSavingWalletModal()" style="display: none; margin-top: 10px;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
                <div class="content-row">
                    <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="100%" height="70">
                        <text x="50%" y="50%" font-family="-apple-syste, Comic Sans MS, sans-serif" font-size="30" font-weight="bold" fill="#382831"text-anchor="middle" alignment-baseline="middle">
                            å…±æœ‰å£åº§
                        </text>
                    </svg>
                </div>

                <form id="WalletForm">
                    <select id="walletMonth" onchange="onchangeWallentMonth()">
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>

                    <input type="number" id="walletDate" placeholder="æ—¥ä»˜">

                    <select id="walletCategory">
                        <option value="æŒ¯è¾¼">æŒ¯è¾¼</option>
                        <option value="æ‰•å‡º">æ‰•å‡º</option>
                    </select>
                    <input type="number" id="walletAmount" placeholder="é‡‘é¡">
                    <button type="button" onclick="saveWallet()">ä¿å­˜</button>
                </form>

                <div class="summary">
                    <p>æ®‹é«˜: <span id="walletCurrent">0</span> å††</p>
                </div>

                <table id="walletTable">
                    <thead>
                        <tr>
                            <th>æœˆ</th>
                            <th>æ—¥</th>
                            <th>åˆ†é¡</th>
                            <th>é‡‘é¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¨˜éŒ²ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>
<!--/////////////////////////////////////////////////////////////////////////
/// ãƒ•ãƒƒã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«
//////////////////////////////////////////////////////////////////////////-->
        <footer>
            <button onclick="showSection('entryFormSection', this)" class="active">
                <span class="material-symbols-outlined">
                    library_books
                </span>
            </button>
            <button onclick="showSection('monthlyGraphSection', this)">
                <span class="material-symbols-outlined">
                    pie_chart
                </span>
            </button>
            <button onclick="showSection('yearlyGraphSection', this)">
                <span class="material-symbols-outlined">
                    bar_chart_4_bars
                </span>
            </button>
            <button onclick="showSection('calendarSection', this)">
                <span class="material-symbols-outlined">
                    calendar_month
                </span>
            </button>
            <button onclick="showSection('walletSection', this)">
                <span class="material-symbols-outlined">
                    wallet
                </span>
            </button>
        </footer>

<!--//////////////////////////////////////////////////////////////////////////
/// èµ·å‹•æ™‚å‡¦ç†
///////////////////////////////////////////////////////////////////////////-->       
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let entries = [];       //å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
            let wallets = [];       //å£åº§é‡‘é¡ãƒªã‚¹ãƒˆ
            let saveEntries = [];   //ä¿å­˜å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
            let selectedMonth = 1;  //å…¥åŠ›ã‚¿ãƒ–ã§é¸æŠã•ã‚Œã¦ã„ã‚‹æœˆ
            let walletCurrent = 0;  //ç¾åœ¨æ®‹é«˜
            let walletBalance = 0;  //è¦‹è¾¼æ®‹é«˜
            let monthlyChart = null;
            let yearlyChart = null;
            
            window.onload = function() {
                fetch("https://script.google.com/macros/s/AKfycbyBGopO2qSAGtUVQtSUc6Wc-Ok-7PjmBUvuGhDLIyeumddTxPMTWs7S2FsUaXhRZmOdBw/exec")
                // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                .then(response => response.json())
                    .then(data => {
                        data.forEach(row => {
                            const month = row[0];
                            const date = row[1];
                            const category = row[2];
                            const amount = row[3];
                            const wallet = { month, date, category, amount };
                            wallets.unshift(wallet);
                        });
                        wallets.forEach(wallet=>{
                            if (wallet.category==='æŒ¯è¾¼') {
                                walletCurrent += wallet.amount;
                            }
                            else if (wallet.category==='æ‰•å‡º') {
                                walletCurrent -= wallet.amount;
                            }
                        });
                        //ã‚¦ã‚©ãƒ¬ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
                        updateWalletDisplay();
                    }
                );
                document.getElementById("loading-modal").style.display = "flex";
                fetch("https://script.google.com/macros/s/AKfycbz_Vi5dDG8ejJyAiPIc3RHuwOi-xZtEXNe3st-soEPFw9YX5WCE9gNcBSsWRbyKBMNqbw/exec")
                    .then(response => response.json())
                    .then(data => {
                        //æœ€çµ‚æœˆã‚’è¨­å®š
                        if (data.length > 0) {
                            selectedMonth = data[data.length - 1][0];
                            document.getElementById('month').value = selectedMonth;
                        }

                        // å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        data.forEach(row => {
                            const month = row[0];
                            const date = row[1];
                            const category = row[3];
                            const amount = row[2];
                            const entry = { date, category, amount, month, isNew:false };
                            entries.unshift(entry);
                        });
                        //å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
                        updateEntriesTable();
                        //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        document.getElementById("loading-message").textContent = "èª­ã¿è¾¼ã¿ã¾ã—ãŸğŸµ";
                        document.getElementById("close-button").style.display = "block";
                    })
                    .catch(error => {
                        document.getElementById("loading-message").textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
                        document.getElementById("close-button").style.display = "block";
                    }
                );
            };
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            function closeLoadingModal() {
                document.getElementById("loading-modal").style.display = "none";
            }
            
//////////////////////////////////////////////////////////////////////////////
/// å…¥åŠ›ç”»é¢å‡¦ç†
//////////////////////////////////////////////////////////////////////////////

            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆ
            document.addEventListener("DOMContentLoaded", function () {
                const table = document.getElementById("entriesTable");
                const headers = table.querySelectorAll("thead th");
                let sortOrder = {}; // å„åˆ—ã®ã‚½ãƒ¼ãƒˆé †ã‚’è¨˜éŒ²

                headers.forEach((header, columnIndex) => {
                    if (columnIndex === 4) return; // å‰Šé™¤ãƒœã‚¿ãƒ³åˆ—ã¯ã‚½ãƒ¼ãƒˆã—ãªã„

                    sortOrder[columnIndex] = 1; // åˆæœŸã¯æ˜‡é †

                    header.addEventListener("click", function () {
                        const tbody = table.querySelector("tbody");
                        const rows = Array.from(tbody.querySelectorAll("tr"));

                        // ã‚½ãƒ¼ãƒˆå‡¦ç†
                        rows.sort((rowA, rowB) => {
                            const cellA = rowA.children[columnIndex].textContent.trim();
                            const cellB = rowB.children[columnIndex].textContent.trim();

                            // æ•°å€¤ã‹ã©ã†ã‹åˆ¤å®š
                            const isNumber = !isNaN(cellA) && !isNaN(cellB);

                            if (isNumber) {
                                return (parseFloat(cellA) - parseFloat(cellB)) * sortOrder[columnIndex];
                            } else {
                                return cellA.localeCompare(cellB, "ja") * sortOrder[columnIndex];
                            }
                        });

                        // ã‚½ãƒ¼ãƒˆé †ã‚’åè»¢
                        sortOrder[columnIndex] *= -1;

                        // ã‚½ãƒ¼ãƒˆã—ãŸè¡Œã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«å†è¿½åŠ 
                        tbody.innerHTML = "";
                        rows.forEach(row => tbody.appendChild(row));
                    });
                });
            });

            // ä¿å­˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚
            function saveEntry(){
                document.getElementById("saving-modal").style.display = "flex";
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‹•ä½œã‚’é˜²ã

                if (saveEntries.length === 0) {
                    document.getElementById("saving-message").textContent = "ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
                    document.getElementById("close-savebutton").style.display = "block";
                    return;
                }

                // saveEntriesã‚’é€ä¿¡å¯èƒ½ãªå½¢å¼ã«å¤‰æ›
                const formData = new URLSearchParams();
                saveEntries.forEach((entry, index) => {
                    Object.keys(entry).forEach(key => {
                        formData.append(`${index}[${key}]`, entry[key]);
                    });
                });

                // Google Apps Scriptã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                fetch("https://script.google.com/macros/s/AKfycbz_Vi5dDG8ejJyAiPIc3RHuwOi-xZtEXNe3st-soEPFw9YX5WCE9gNcBSsWRbyKBMNqbw/exec", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById("saving-message").textContent = "ä¿å­˜ã—ã¾ã—ãŸğŸµ";
                        document.getElementById("close-savebutton").style.display = "block";

                        entries.forEach(entry => {
                            if (saveEntries.includes(entry)) {
                                entry.isNew = false;
                            }
                        });
                        saveEntries = []; // ä¿å­˜æ¸ˆã¿ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢
                        updateEntriesTable();
                    } else {
                        document.getElementById("saving-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                        document.getElementById("close-savebutton").style.display = "block";
                    }
                })
                .catch(error => {
                    console.error("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    document.getElementById("saving-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    document.getElementById("close-savebutton").style.display = "block";
                });
            }
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            function closeSavingModal() {
                document.getElementById("saving-modal").style.display = "none";
            }

            // è¿½åŠ ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
            function addEntry() {
                const date = document.getElementById('date').value;
                const category = document.getElementById('category').value;
                const amount = parseInt(document.getElementById('amount').value);
                const month = parseInt(document.getElementById('month').value);

                if (isNaN(amount) || !date) {
                    alert('é‡‘é¡ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const entry = { date, category, amount, month, isNew:true };
                entries.unshift(entry);
                saveEntries.unshift(entry);

                document.getElementById('amount').value=null;

                updateEntriesTable();
            }

            // ã‚¨ãƒ³ãƒˆãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
            function updateEntriesTable() {
                const tbody = document.getElementById('entriesTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                let totalExpense = 0;

                entries.filter(entry => entry.month === selectedMonth).forEach(entry => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = entry.month;
                        row.insertCell(1).textContent = entry.date;
                        row.insertCell(2).textContent = entry.category;
                        row.insertCell(3).textContent = entry.amount;

                        // å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
                        const deleteCell = row.insertCell(4);
                        if(entry.isNew){
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'å‰Šé™¤';
                        deleteButton.onclick = () => {
                            entries = entries.filter(e => e !== entry);
                            saveEntries = saveEntries.filter(e => e !== entry);
                            updateEntriesTable();
                        };
                        deleteCell.appendChild(deleteButton);
                    }

                    totalExpense += entry.amount;
                });

                // ç·æ”¯å‡ºã®è¡¨ç¤º
                document.getElementById('totalExpense').textContent = totalExpense;
            }
            //å…¥åŠ›ã‚¿ãƒ–ã®æœˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ã
            function onchangeEntryMonth(){
                selectedMonth = parseInt(document.getElementById('month').value);
                updateEntriesTable();
            }

//////////////////////////////////////////////////////////////////////////////
/// æœˆã‚°ãƒ©ãƒ•å‡¦ç†
//////////////////////////////////////////////////////////////////////////////

            // æœˆã‚¿ãƒ–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ã
            function onchangeSelectMonth(){
                const month = parseInt(document.getElementById('monthgraph_month').value);
                updateMonthlyGraph(month);
            }
            //æœˆã‚°ãƒ©ãƒ•ã®æ›´æ–°
            function updateMonthlyGraph(month) {
                if (monthlyChart) {
                    monthlyChart.destroy();
                }

                const categoryAmounts = {
                    'ãŠè‚‰': 0, 'é£²æ–™': 0, 'é‡èœ': 0, 'ãŠè“å­': 0, 'ç”Ÿæ´»ç”¨å“': 0, 'å¤–é£Ÿ': 0,
                    'ç‰¹åˆ¥': 0, 'æ°´é“': 0, 'ã‚¬ã‚¹': 0, 'é›»æ°—': 0, 'ãã®ä»–': 0
                };

                let hasData = false;

                // ãã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                entries.forEach(entry => {
                    if (entry.month === month) {
                        categoryAmounts[entry.category] += entry.amount;
                        hasData = true;
                    }
                });

                if (!hasData) {
                    alert(`${month}æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }

                
                // é‡‘é¡ãŒ0ã§ãªã„åˆ†é¡ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const filteredCategoryAmounts = Object.fromEntries(
                    Object.entries(categoryAmounts).filter(([category, amount]) => amount > 0)
                );

                if (Object.keys(filteredCategoryAmounts).length === 0) {
                    alert(`${month}æœˆã«é‡‘é¡ãŒ0ã®åˆ†é¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }

                // ãƒ©ãƒ™ãƒ«ã‚’ã€Œåˆ†é¡ï¼šé‡‘é¡ã€ã®å½¢å¼ã«å¤‰æ›
                const labels = Object.keys(filteredCategoryAmounts).map(
                    category => `${category}ï¼š${filteredCategoryAmounts[category]}å††`
                );

                const ctx = document.getElementById('monthlyGraph').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${month}æœˆã®æ”¯å‡º`,
                            data: Object.values(filteredCategoryAmounts),
                            backgroundColor: ['#FFB7C5', '#AEC6CF', '#77DD77', '#FDFD96', '#CBAACB', '#FFB347', '#FBEEC1', '#FF9AA2', '#E6E6FA', '#B2F2E9', '#D3D3D3'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false,
                                position: 'top',
                                labels: {
                                    boxWidth: 20,
                                    padding: 10
                                }
                            },
                            tooltip: {
                                enabled: false // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ç„¡åŠ¹ã«ã™ã‚‹
                            }
                        }
                    },
                    plugins: [{
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                if (!meta.hidden) {
                                    meta.data.forEach((element, index) => {
                                        const label = `${chart.data.labels[index]}`; // "åˆ†é¡ï¼šé‡‘é¡"ã®å½¢å¼
                                        const position = element.tooltipPosition();

                                        // ã‚°ãƒ©ãƒ•ã®ä¸­å¿ƒä½ç½®ã‚’å–å¾—
                                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;

                                        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­å¿ƒã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè·é›¢ã‚’è¨ˆç®—
                                        const deltaX = position.x - centerX;
                                        const deltaY = position.y - centerY;

                                        // ä½ç½®èª¿æ•´
                                        const offsetX = centerX + deltaX * 1.5;
                                        const offsetY = centerY + deltaY * 1.5;

                                        ctx.fillStyle = '#382831'; // ãƒ†ã‚­ã‚¹ãƒˆã®è‰²

                                        // ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
                                        ctx.font = 'bold 12px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';

                                        ctx.fillText(label, offsetX, offsetY);
                                    });
                                }
                            });
                        }
                    }]
                });
            }

//////////////////////////////////////////////////////////////////////////////
/// å¹´ã‚°ãƒ©ãƒ•å‡¦ç†
//////////////////////////////////////////////////////////////////////////////

            // å¹´ã‚°ãƒ©ãƒ•ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã
            function onchangeSelectYear(){
                const selectedCategory = document.getElementById('yeargraph_category').value;
                if (selectedCategory === 'total') {
                    updateYearlyGraph();
                } else {
                    updateCategoryYearlyGraph(selectedCategory);
                }
            }

            // ç·æ”¯å‡ºã‚°ãƒ©ãƒ•
            function updateYearlyGraph() {
                if (yearlyChart) {
                    yearlyChart.destroy();
                }
                // å„æœˆã®ç·æ”¯å‡ºã‚’è¨ˆç®—
                const monthlyTotals = Array(12).fill(0);
                entries.forEach(entry => {
                    monthlyTotals[entry.month - 1] += entry.amount;
                });

                const ctx = document.getElementById('yearlyGraph').getContext('2d');
                yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                        datasets: [{
                            label: 'ç·æ”¯å‡º',
                            data: monthlyTotals,
                            backgroundColor: '#382831',
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }


            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚°ãƒ©ãƒ•
            function updateCategoryYearlyGraph(category) {
                if (yearlyChart) {
                    yearlyChart.destroy();
                }

                const categoryColors = {
                    'ãŠè‚‰': '#FFB7C5',
                    'é£²æ–™': '#AEC6CF',
                    'é‡èœ': '#77DD77',
                    'ãŠè“å­': '#FDFD96',
                    'ç”Ÿæ´»ç”¨å“': '#CBAACB',
                    'å¤–é£Ÿ': '#FFB347',
                    'ç‰¹åˆ¥': '#FBEEC1',
                    'æ°´é“': '#FF9AA2',
                    'ã‚¬ã‚¹': '#E6E6FA',
                    'é›»æ°—': '#B2F2E9',
                    'ãã®ä»–': '#D3D3D3'
                };

                const monthlyTotals = Array(12).fill(0);

                entries.forEach(entry => {
                    if (entry.category === category) {
                        monthlyTotals[entry.month - 1] += entry.amount;
                    }
                });

                const colors = monthlyTotals.map(() => categoryColors[category] || '#382831');

                const ctx = document.getElementById('yearlyGraph').getContext('2d');
                yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                        datasets: [{
                            label: `${category}ã®æœˆåˆ¥æ”¯å‡º`,
                            data: monthlyTotals,
                            backgroundColor: colors,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
//////////////////////////////////////////////////////////////////////////////
/// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‡¦ç†
//////////////////////////////////////////////////////////////////////////////
            function updateCalendar() {
                const selectedMonth = document.getElementById("calendarMonth").value;
                generateCalendar(selectedMonth);
            }

            function generateCalendar(month) {
                const tbody = document.querySelector("#calendar tbody");
                tbody.innerHTML = "";

                const firstDay = new Date(2025, month - 1, 1).getDay();
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                const daysInMonth = new Date(2025, month, 0).getDate();

                let row = document.createElement("tr");
                let weeklyTotals = {
                    é£Ÿè²»: 0,
                    ç”Ÿæ´»ç”¨å“: 0,
                    å¤–é£Ÿè²»: 0,
                    ç‰¹åˆ¥è²»: 0
                };

                // æœˆã®åˆã‚ã®ç©ºç™½ã®ã‚»ãƒ«ã‚’è¿½åŠ 
                for (let i = 0; i < adjustedFirstDay; i++) {
                    row.appendChild(document.createElement("td"));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    let cell = document.createElement("td");

                    // æ—¥ä»˜ã‚’è¡¨ç¤º
                    let dateSpan = document.createElement("span");
                    dateSpan.textContent = day;
                    cell.appendChild(dateSpan);

                    // å„è²»ç”¨ã®è¡¨ç¤ºï¼ˆ0å††ã§ã‚‚è¡¨ç¤ºï¼‰
                    let expenses = [
                        { category: "é£Ÿè²»", class: "food" },
                        { category: "ç”Ÿæ´»ç”¨å“", class: "household" },
                        { category: "å¤–é£Ÿè²»", class: "dining" },
                        { category: "ç‰¹åˆ¥è²»", class: "special" }
                    ];

                    expenses.forEach(expense => {
                        let expenseSpan = document.createElement("span");
                        expenseSpan.classList.add("expense", expense.class);
                        let amount = calculateExpense(day, expense.category, month); // æœˆã¨æ—¥ä»˜ã«åŸºã¥ãé‡‘é¡ã‚’è¨ˆç®—
                        expenseSpan.textContent = `${amount}å††`; // ã‚«ãƒ†ã‚´ãƒªåã¯è¡¨ç¤ºã›ãšã€é‡‘é¡ã®ã¿
                        cell.appendChild(expenseSpan);

                        // é€±ã”ã¨ã®åˆè¨ˆã‚’è¨ˆç®—
                        weeklyTotals[expense.category] += amount;
                    });

                    row.appendChild(cell);

                    // æ—¥æ›œæ—¥ï¼ˆ7æ—¥ç›®ï¼‰ã¾ãŸã¯æœˆæœ«ã®æ™‚ã«é€±åˆè¨ˆã‚’è¡¨ç¤º
                    if ((day + adjustedFirstDay) % 7 === 0 || day === daysInMonth) {
                        // é€±åˆè¨ˆåˆ—ã‚’è¿½åŠ 
                        let summaryCell = document.createElement("td");

                        // é£Ÿè²»
                        let foodSpan = document.createElement("span");
                        foodSpan.classList.add("weekly-total", "food");
                        foodSpan.textContent = `${weeklyTotals.é£Ÿè²»}å††`;
                        summaryCell.appendChild(foodSpan);

                        // ç”Ÿæ´»ç”¨å“
                        let householdSpan = document.createElement("span");
                        householdSpan.classList.add("weekly-total", "household");
                        householdSpan.textContent = `${weeklyTotals.ç”Ÿæ´»ç”¨å“}å††`;
                        summaryCell.appendChild(householdSpan);

                        // å¤–é£Ÿè²»
                        let diningSpan = document.createElement("span");
                        diningSpan.classList.add("weekly-total", "dining");
                        diningSpan.textContent = `${weeklyTotals.å¤–é£Ÿè²»}å††`;
                        summaryCell.appendChild(diningSpan);

                        // ç‰¹åˆ¥è²»
                        let specialSpan = document.createElement("span");
                        specialSpan.classList.add("weekly-total", "special");
                        specialSpan.textContent = `${weeklyTotals.ç‰¹åˆ¥è²»}å††`;
                        summaryCell.appendChild(specialSpan);

                        row.appendChild(summaryCell);
                        tbody.appendChild(row);
                        row = document.createElement("tr");

                        // é€±åˆè¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
                        weeklyTotals = {
                            é£Ÿè²»: 0,
                            ç”Ÿæ´»ç”¨å“: 0,
                            å¤–é£Ÿè²»: 0,
                            ç‰¹åˆ¥è²»: 0
                        };
                    }
                }
            }

            // è¨ˆç®—ã—ãŸè²»ç”¨ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            function calculateExpense(day, category, month) {
                let total = 0;
                entries.forEach(entry => {
                    if (entry.month == month && entry.date == day) {
                        if (category === "é£Ÿè²»" && ["ãŠè‚‰", "é‡èœ", "é£²æ–™", "ãŠè“å­", "ãã®ä»–"].includes(entry.category)) {
                            total += entry.amount;
                        } else if (category === "ç”Ÿæ´»ç”¨å“" && entry.category === "ç”Ÿæ´»ç”¨å“") {
                            total += entry.amount;
                        } else if (category === "å¤–é£Ÿè²»" && entry.category === "å¤–é£Ÿ") {
                            total += entry.amount;
                        } else if (category === "ç‰¹åˆ¥è²»" && entry.category === "ç‰¹åˆ¥") {
                            total += entry.amount;
                        }
                    }
                });
                return total === 0 ? "0" : total; // 0å††ã‚‚è¡¨ç¤ºã™ã‚‹
            }



//////////////////////////////////////////////////////////////////////////////
/// ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå‡¦ç†
//////////////////////////////////////////////////////////////////////////////
            // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä¿å­˜å‡¦ç†
            function saveWallet(){
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‹•ä½œã‚’é˜²ã
                const month = parseInt(document.getElementById("walletMonth").value);
                const date = document.getElementById("walletDate").value;
                const category = document.getElementById("walletCategory").value;
                const amount = parseInt(document.getElementById("walletAmount").value);
                if (category==='æŒ¯è¾¼') {
                    walletCurrent += amount;
                }
                else if (category==='æ‰•å‡º') {
                    walletCurrent -= amount;
                }
                else{
                    alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ã‚„â™ª");
                }
                document.getElementById("walletDate").value = "";
                document.getElementById("walletAmount").value = "";

                const wallet={ month, date, category, amount };
                wallets.unshift(wallet);
                if (wallet.length === 0) {
                    alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    return;
                }

                // savewalletã‚’é€ä¿¡å¯èƒ½ãªå½¢å¼ã«å¤‰æ›
                const formData = new URLSearchParams();
                Object.keys(wallet).forEach(key => {
                    formData.append(`0[${key}]`, wallet[key]);
                });
                document.getElementById("savingwallet-modal").style.display = "flex";

                // Google Apps Scriptã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                fetch("https://script.google.com/macros/s/AKfycbyBGopO2qSAGtUVQtSUc6Wc-Ok-7PjmBUvuGhDLIyeumddTxPMTWs7S2FsUaXhRZmOdBw/exec", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById("savingwallet-message").textContent = "ä¿å­˜ã—ã¾ã—ãŸâ™ª";
                        document.getElementById("close-savewalletbutton").style.display = "block";
                        updateWalletDisplay()
                    } else {
                        document.getElementById("savingwallet-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                        document.getElementById("close-savewalletbutton").style.display = "block";
                    }
                })
                .catch(error => {
                    document.getElementById("savingwallet-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    document.getElementById("close-savewalletbutton").style.display = "block";
                });
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            function closeSavingWalletModal() {
                document.getElementById("savingwallet-modal").style.display = "none";
            }

            // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè¡¨ç¤ºã®æ›´æ–°
            function updateWalletDisplay() {
                const tbody = document.getElementById('walletTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                wallets.forEach(wallet => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = wallet.month;
                        row.insertCell(1).textContent = wallet.date;
                        row.insertCell(2).textContent = wallet.category;
                        row.insertCell(3).textContent = wallet.amount;
            });
                document.getElementById("walletCurrent").textContent = walletCurrent;
                document.getElementById("walletBalance").textContent = walletBalance;
            }

//////////////////////////////////////////////////////////////////////////////
/// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
//////////////////////////////////////////////////////////////////////////////
            function showSection(sectionId, button) {
                const sections = ['entryFormSection', 'monthlyGraphSection', 'yearlyGraphSection','calendarSection','walletSection'];
                sections.forEach(id => {
                    const section = document.getElementById(id);
                    section.style.display = (id === sectionId) ? 'block' : 'none';
                });

                const buttons = document.querySelectorAll('footer button');
                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // å„ã‚¿ãƒ–ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
                if (sectionId === 'monthlyGraphSection') {
                    const correntmonth = document.getElementById('month').value
                    document.getElementById('monthgraph_month').value = correntmonth;
                    updateMonthlyGraph(parseInt(correntmonth, 10));
                } else if (sectionId === 'yearlyGraphSection') {
                    document.getElementById('yeargraph_category').value = 'total';
                    updateYearlyGraph();
                } else if (sectionId === 'calendarSection') {
                    updateCalendar();
                } else if (sectionId === 'walletSection') {
                    updateWalletDisplay();
                }
            }
        </script>
    </body>
</html>
